name: Build, Test & Deploy ASP.NET Backend

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    steps:
      # ğŸ§© BÆ°á»›c 1: Láº¥y source code
      - name: Checkout source
        uses: actions/checkout@v4

      # ğŸ§° BÆ°á»›c 2: CÃ i Ä‘áº·t .NET SDK (chá»‰nh version náº¿u cáº§n)
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # ğŸ§± BÆ°á»›c 3: Restore dependencies
      - name: Restore dependencies
        run: dotnet restore

      # ğŸ§ª BÆ°á»›c 4: Build project
      - name: Build
        run: dotnet build --configuration Release --no-restore

      # âœ… BÆ°á»›c 5: Run tests (náº¿u cÃ³ project test)
      - name: Test
        run: dotnet test --no-build --verbosity normal
        continue-on-error: true  # náº¿u khÃ´ng cÃ³ test, CI váº«n tiáº¿p tá»¥c

      # ğŸ³ BÆ°á»›c 6: Build Docker image
      - name: Build Docker image
        run: docker build -t weddingserver:latest .

      # ğŸ“¦ BÆ°á»›c 7: Save Docker image thÃ nh file .tar Ä‘á»ƒ upload sang server
      - name: Save Docker image
        run: docker save weddingserver:latest -o weddingserver.tar

      # ğŸš€ BÆ°á»›c 8: Copy image vÃ  deploy script sang server qua SSH
      - name: Upload and deploy to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASS }}
          port: 24700
          source: "weddingserver.tar"
          target: "/root/"

      # âš™ï¸ BÆ°á»›c 9: SSH vÃ o server Ä‘á»ƒ load & cháº¡y container
      - name: Deploy container on VPS
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASS }}
          port: 24700
          script: |
            echo "ğŸš€ Deploying container..."
            docker load -i /root/weddingserver.tar
            docker stop weddingserver || true
            docker rm weddingserver || true
            docker run -d \
              --name weddingserver \
              -p 80:8080 \
              -e aspnetcore_environment=Production \
              -e Password="${{ secrets.ADMIN_PASSWORD }}" \
              -e Cloudinary__CloudName="${{ secrets.CLOUDINARY_NAME }}" \
              -e Cloudinary__ApiKey="${{ secrets.CLOUDINARY_KEY }}" \
              -e Cloudinary__ApiSecret="${{ secrets.CLOUDINARY_SECRET }}" \
              -e MongoSettings__DatabaseWedding1__ConnectionString="${{ secrets.MONGO_URI }}" \
              -e MongoSettings__DatabaseWedding1__DatabaseName=WeddingManager \
              weddingserver:latest
            echo "âœ… Deployment successful!"
