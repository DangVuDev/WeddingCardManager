name: Build, Test & Deploy WeddingServer

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    steps:
      # ğŸ§© 1ï¸âƒ£ Láº¥y source code
      - name: Checkout source
        uses: actions/checkout@v4

      # ğŸ§° 2ï¸âƒ£ CÃ i Ä‘áº·t .NET SDK 8.0
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # ğŸ§± 3ï¸âƒ£ Restore dependencies
      - name: Restore dependencies
        run: dotnet restore WeddingServer/WeddingServer.csproj

      # ğŸ§ª 4ï¸âƒ£ Build project
      - name: Build
        run: dotnet build WeddingServer/WeddingServer.csproj --configuration Release --no-restore

      # âœ… 5ï¸âƒ£ Run tests (náº¿u cÃ³)
      - name: Test
        run: dotnet test --no-build --verbosity normal
        continue-on-error: true

      # ğŸ³ 6ï¸âƒ£ Build Docker image (giá»¯ nguyÃªn vá»‹ trÃ­ Dockerfile)
      - name: Build Docker image
        run: docker build -t weddingserver:latest -f WeddingServer/Dockerfile .

      # ğŸ“¦ 7ï¸âƒ£ Save Docker image Ä‘á»ƒ upload lÃªn VPS
      - name: Save Docker image
        run: docker save weddingserver:latest -o weddingserver.tar

      # ğŸ”§ Fix quyá»n file (báº¯t buá»™c Ä‘á»ƒ scp Ä‘á»c Ä‘Æ°á»£c)
      - name: Fix file permissions
        run: chmod 644 weddingserver.tar

      # ğŸš€ 8ï¸âƒ£ Upload Docker image lÃªn server
      - name: Upload Docker image
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASS }}
          port: 24700
          source: "weddingserver.tar"
          target: "/root/"

      # âš™ï¸ 9ï¸âƒ£ Deploy container trÃªn VPS
      - name: Deploy container on VPS
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASS }}
          port: 24700
          script: |
            echo "ğŸš€ Deploying WeddingServer container..."
            docker load -i /root/weddingserver.tar
            docker stop weddingserver || true
            docker rm weddingserver || true
            docker run -d \
              --name weddingserver \
              -p 80:8080 \
              -e aspnetcore_environment=Production \
              -e Password="${{ secrets.ADMIN_PASSWORD }}" \
              -e Cloudinary__CloudName="${{ secrets.CLOUDINARY_NAME }}" \
              -e Cloudinary__ApiKey="${{ secrets.CLOUDINARY_KEY }}" \
              -e Cloudinary__ApiSecret="${{ secrets.CLOUDINARY_SECRET }}" \
              -e MongoSettings__DatabaseWedding1__ConnectionString="${{ secrets.MONGO_URI }}" \
              -e MongoSettings__DatabaseWedding1__DatabaseName=WeddingManager \
              weddingserver:latest
            echo "âœ… Deployment successful!"
